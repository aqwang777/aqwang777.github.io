---
layout: post
title:  "java类的加载机制"
categories: javase
tags:  javase
author: aqwang
---

* content
{:toc}


### 什么是类的加载

- 类的加载是指将类的.class文件的二进制数据读入内存中，放在运行时数据区的方法区内，然后在堆区创建一个java.lang.Class对象，封装类在方法区的数据结构。类加载的最终产品是在堆区中的Class对象，Class对象封装了类在方法区的数据结构，然后向JAVA程序员提供了可以访问方法区内数据结构的接口。
- 类加载器不需要等到某个类被首次主动使用才开始加载，JVM允许类加载器在预料某个类要被使用时才开始加载它，如果预先加载的过程中遇到了.class文件缺失等错误，类加载器必须在程序首次使用该类时才报错（LinkageError错误），如果一直没主动使用该类，就不会报错。
- ![](..\msg\1.png)

### 类的生命周期

- 类的加载过程包括了加载，验证，准备，解析，初始化五个阶段，图片如下：

  ![](..\msg\331425-20160621125943209-1443333281.png)



- 在这个过程中，加载，验证，准备，初始化这四个步骤发生顺序是确定的，解析阶段则是可以在初始化之后才开始，这是为了支持java语言的动态绑定。另外注意这里的几个阶段是按顺序开始，而不是按顺序进行或完成，因为这些阶段通常都是互相交叉地混合进行的，通常在一个阶段执行的过程中调用或激活另一个阶段。

#### 加载

查找并加载类的二进制数据是类加载过程中的第一个阶段,在加载阶段，虚拟机需要完成三件事情：

- 通过一个类的全限定名来获取其定义的二进制字节流。

- 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。

- 在JAVA堆中生成一个代表该类的java.lang.Class对象，作为对方法区这些数据的访问入口。

加载阶段相比于其他阶段,可控性更强,因为开发者可以使用系统自带的类加载器,也可以自己定义类加载器.

#### 连接

##### 验证：确保被加载类的正确性

验证是连接阶段的第一步,这个阶段的目的是确保Class文件字节流中包含的信息符合当前虚拟机的要求，并不会危害虚拟机自身安全。验证有四个验证动作：

- 文件格式验证

- 元数据验证

- 字节码验证

- 符号引用验证

验证阶段十分重要但不是必须的，它对程序运行期没有影响，如果所引用的类反复经过验证，可以考虑用-Xverifynone参数来关闭大部分的类验证措施，来缩短类加载时间。

##### 准备：为类的静态变量分配内存，将其初始化为默认值

准备阶段是正式为类变量分配内存并设置变量初始值的阶段，内存在方法区中分配。

设置变量初始值的意思



